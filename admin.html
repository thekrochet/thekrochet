<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel | TheKrochet</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="brand.css"> 

<style>
/* ADMIN SPECIFIC STYLES */
body { background: #121212; color: #fff; padding-bottom: 50px; }

/* Navbar */
nav {
  display: flex; justify-content: space-between; align-items: center;
  padding: 15px 5%; background: #1e1e1e; border-bottom: 1px solid #333;
  position: sticky; top: 0; z-index: 100;
}
.logo { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--primary); }
.nav-links button {
  background: none; border: none; color: #aaa; font-size: 1rem; 
  margin-left: 20px; cursor: pointer; transition: 0.3s;
}
.nav-links button.active, .nav-links button:hover { color: var(--primary); }

/* Login Modal */
#loginModal {
  position: fixed; inset: 0; background: #000; z-index: 2000;
  display: flex; align-items: center; justify-content: center;
}
.login-box {
  background: #1e1e1e; padding: 40px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px;
  border: 1px solid #333;
}
.login-box input {
  width: 100%; padding: 12px; margin: 10px 0; background: #2a2a2a; border: 1px solid #444; 
  color: #fff; border-radius: 8px; outline: none;
}
.login-box button {
  width: 100%; padding: 12px; background: var(--primary); color: #000; font-weight: bold;
  border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;
}

/* Sections */
.section { display: none; padding: 20px; max-width: 1200px; margin: auto; }
.section.active { display: block; }

/* Product Grid */
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
.card {
  background: #1e1e1e; border-radius: 15px; padding: 15px; border: 1px solid #333;
  transition: 0.3s; position: relative; overflow: hidden;
}
.card img { width: 100%; height: 200px; object-fit: cover; border-radius: 10px; background: #2a2a2a; }
.card h3 { margin: 10px 0 5px; font-size: 1.1rem; }
.card .price { color: var(--primary); font-weight: bold; }
.actions { display: flex; gap: 10px; margin-top: 15px; }
.actions button {
  flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600;
}
.btn-edit { background: #333; color: #fff; }
.btn-del { background: #3a1c1c; color: #ff6b6b; }

/* Add Button */
.fab {
  position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
  background: var(--primary); color: #000; border-radius: 50%; font-size: 30px;
  display: flex; align-items: center; justify-content: center; cursor: pointer;
  box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 100;
}

/* Modal Form */
.modal {
  position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000;
  display: none; align-items: center; justify-content: center;
}
.modal.active { display: flex; }
.modal-box {
  background: #1e1e1e; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px;
  max-height: 90vh; overflow-y: auto; border: 1px solid #333;
}
.modal-box h2 { margin-bottom: 20px; color: var(--primary); }
.modal-box input, .modal-box textarea {
  width: 100%; padding: 12px; margin-bottom: 15px; background: #2a2a2a; 
  border: 1px solid #444; color: #fff; border-radius: 8px; outline: none;
}
.btns { display: flex; gap: 10px; }
.btns button { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
.btn-save { background: var(--primary); color: #000; }
.btn-cancel { background: #333; color: #fff; }

/* Orders List */
.order-card { background: #1e1e1e; padding: 20px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #333; }
.order-header { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #333; }
.status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; background: #333; }
</style>
</head>
<body>

<div id="loginModal">
  <div class="login-box">
    <h2 style="margin-bottom:20px;color:var(--primary)">Admin Login</h2>
    <input type="email" id="adminEmail" placeholder="Email">
    <input type="password" id="adminPass" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>
</div>

<nav>
  <div class="logo">TheKrochet ☀️</div>
  <div class="nav-links">
    <button onclick="showSection('products')" class="active">Products</button>
    <button onclick="showSection('reviews')">Reviews</button>
    <button onclick="showSection('orders')">Orders</button>
    <button onclick="logout()">Logout</button>
  </div>
</nav>

<div id="products" class="section active">
  <div class="grid" id="productGrid"></div>
  <div class="fab" onclick="openProductModal()">+</div>
</div>

<div id="reviews" class="section">
  <div class="grid" id="reviewGrid"></div>
</div>

<div id="orders" class="section">
  <div id="orderList"></div>
</div>

<div id="productModal" class="modal">
  <div class="modal-box">
    <h2 id="modalTitle">Add Product</h2>
    <input id="pName" placeholder="Product Name">
    <input id="pPrice" type="number" placeholder="Price (₹)">
    <textarea id="pDesc" rows="3" placeholder="Description"></textarea>
    <input id="pImage" placeholder="Image Link(s) - Separate with comma for slider">
    <div class="btns">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="saveProduct()">Save</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* FIREBASE CONFIG */
firebase.initializeApp({
  apiKey:"AIzaSyAbFV0WbIVMpibxnIiVbwtnOqtvJ6ts_sY",
  authDomain:"thekrochet-b3ca2.firebaseapp.com",
  projectId:"thekrochet-b3ca2"
});
const auth = firebase.auth();
const db = firebase.firestore();

let editingId = null;

/* AUTH STATE */
auth.onAuthStateChanged(user => {
  if(user && user.email === "thekrochet@admin.com"){
    document.getElementById("loginModal").style.display = "none";
    loadProducts();
    loadReviews();
    loadOrders();
  } else {
    document.getElementById("loginModal").style.display = "flex";
  }
});

function login(){
  const e = document.getElementById("adminEmail").value;
  const p = document.getElementById("adminPass").value;
  auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
}

function logout(){ auth.signOut(); }

/* NAVIGATION */
function showSection(id){
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".nav-links button").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  event.target.classList.add("active");
}

/* --- PRODUCTS --- */
function loadProducts(){
  db.collection("products").orderBy("createdAt", "desc").onSnapshot(snap => {
    const grid = document.getElementById("productGrid");
    grid.innerHTML = "";
    snap.forEach(doc => {
      const p = doc.data();
      
      // ✅ FIX: HANDLE COMMA IMAGES FOR THUMBNAIL
      let displayImg = p.image;
      
      // 1. If 'images' array exists, take first one
      if(p.images && p.images.length > 0) displayImg = p.images[0];
      
      // 2. If 'image' string has comma, take first part
      if(displayImg && displayImg.includes(",")){
        displayImg = displayImg.split(",")[0].trim();
      }

      // 3. Fallback if empty
      if(!displayImg) displayImg = "https://via.placeholder.com/150?text=No+Img";

      grid.innerHTML += `
        <div class="card">
          <img src="${displayImg}" onerror="this.src='https://via.placeholder.com/150'">
          <h3>${p.name}</h3>
          <div class="price">₹${p.price}</div>
          <div class="actions">
            <button class="btn-edit" onclick="editProduct('${doc.id}', '${p.name}', ${p.price}, '${p.description||''}', '${p.image||''}')">Edit</button>
            <button class="btn-del" onclick="deleteProduct('${doc.id}')">Delete</button>
          </div>
        </div>`;
    });
  });
}

function saveProduct(){
  const name = document.getElementById("pName").value;
  const price = Number(document.getElementById("pPrice").value);
  const desc = document.getElementById("pDesc").value;
  const image = document.getElementById("pImage").value;

  const data = {
    name, price, description: desc, image,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  if(editingId){
    db.collection("products").doc(editingId).update(data);
  } else {
    db.collection("products").add(data);
  }
  closeModal();
}

function deleteProduct(id){
  if(confirm("Delete this product?")) db.collection("products").doc(id).delete();
}

/* MODAL LOGIC */
function openProductModal(){
  editingId = null;
  document.getElementById("modalTitle").innerText = "Add Product";
  document.getElementById("pName").value = "";
  document.getElementById("pPrice").value = "";
  document.getElementById("pDesc").value = "";
  document.getElementById("pImage").value = "";
  document.getElementById("productModal").classList.add("active");
}

function editProduct(id, name, price, desc, img){
  editingId = id;
  document.getElementById("modalTitle").innerText = "Edit Product";
  document.getElementById("pName").value = name;
  document.getElementById("pPrice").value = price;
  document.getElementById("pDesc").value = desc;
  document.getElementById("pImage").value = img; // Shows full link string (comma included)
  document.getElementById("productModal").classList.add("active");
}

function closeModal(){
  document.getElementById("productModal").classList.remove("active");
}

/* --- REVIEWS --- */
function loadReviews(){
  db.collection("reviews").orderBy("createdAt", "desc").onSnapshot(snap => {
    const grid = document.getElementById("reviewGrid");
    grid.innerHTML = "";
    snap.forEach(doc => {
      const r = doc.data();
      grid.innerHTML += `
        <div class="card" style="padding:20px;">
          <div style="color:#f1c40f;margin-bottom:10px;">${"★".repeat(r.rating)}</div>
          <p>"${r.text}"</p>
          <small style="color:#888;display:block;margin-top:10px;">— ${r.name}</small>
          <button class="btn-del" style="margin-top:15px;width:100%;padding:8px;" onclick="deleteReview('${doc.id}')">Delete Review</button>
        </div>`;
    });
  });
}
function deleteReview(id){
  if(confirm("Delete this review?")) db.collection("reviews").doc(id).delete();
}

/* --- ORDERS --- */
function loadOrders(){
  db.collection("orders").orderBy("createdAt", "desc").onSnapshot(snap => {
    const list = document.getElementById("orderList");
    list.innerHTML = "";
    snap.forEach(doc => {
      const o = doc.data();
      let itemsHtml = o.items.map(i => `<div>• ${i.name} (₹${i.price})</div>`).join("");
      
      list.innerHTML += `
        <div class="order-card">
          <div class="order-header">
            <strong>${o.customerName} <span style="color:#888">(@${o.instagram})</span></strong>
            <span class="status-badge">${o.status}</span>
          </div>
          <div style="margin-bottom:10px;color:#ccc;">${itemsHtml}</div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong style="color:var(--primary)">Total: ₹${o.total}</strong>
            <button class="btn-del" style="padding:6px 15px;" onclick="deleteOrder('${doc.id}')">Archive</button>
          </div>
        </div>`;
    });
  });
}
function deleteOrder(id){
  if(confirm("Archive this order?")) db.collection("orders").doc(id).delete();
}
</script>

</body>
</html>

