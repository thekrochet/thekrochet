<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Profile | TheKrochet</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="brand.css">
<link rel="stylesheet" href="responsive.css">

<style>
/* Internal Styles for Profile */
:root {
  --bg:#faf7f2; --text:#2f2f2f; --card:#ffffff; --primary:#d4a373; --primary-dark:#b8895b;
}
body.dark { --bg:#121212; --text:#f1f1f1; --card:#1e1e1e; }

body {
  font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text);
  min-height: 100vh; display: flex; flex-direction: column;
}

/* Navbar (Same as Products) */
nav {
  position: sticky; top: 0; z-index: 100; background: var(--nav); backdrop-filter: blur(10px);
  padding: 15px 20px; display: flex; flex-direction: column; gap: 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.05);
}
.nav-line-1 { display: flex; justify-content: center; align-items: center; position: relative; width: 100%; }
.nav-logo { font-family: 'Playfair Display', serif; font-size: 1.8rem; color: var(--text); text-decoration: none; font-weight: 700; }
#logoutBtn { position: absolute; right: 0; font-size: 0.9rem; font-weight: 600; color: var(--primary-dark); cursor: pointer; border: 1px solid var(--primary); padding: 6px 16px; border-radius: 20px; }

.nav-line-2 { display: flex; justify-content: center; gap: 25px; flex-wrap: wrap; }
.nav-links a { text-decoration: none; color: var(--text); opacity: 0.7; transition: 0.3s; }
.nav-links a:hover, .nav-links a.active { opacity: 1; color: var(--primary); }

/* Profile Container */
.container { max-width: 800px; margin: 40px auto; padding: 20px; flex: 1; }
.header { text-align: center; margin-bottom: 40px; }
.header h2 { font-family: 'Playfair Display', serif; font-size: 2.2rem; color: var(--primary-dark); margin-bottom: 10px; }
.header p { opacity: 0.7; }

/* Order Cards */
.order-card {
  background: var(--card); padding: 25px; border-radius: 20px; margin-bottom: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);
  animation: slideUp 0.5s ease forwards;
}
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.order-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 15px; margin-bottom: 15px; }
.order-id { font-size: 0.85rem; opacity: 0.6; }
.status { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }

.status.Pending { background: #fff3cd; color: #856404; }
.status.Shipped { background: #d4edda; color: #155724; }
.status.Cancelled { background: #f8d7da; color: #721c24; }

.order-items { margin-bottom: 15px; }
.item-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }

.order-total { text-align: right; font-weight: 700; color: var(--primary-dark); font-size: 1.1rem; }

.empty-state { text-align: center; padding: 50px; opacity: 0.6; }

/* Mobile */
@media (max-width: 600px) {
  .nav-logo { font-size: 1.5rem; margin-right: 60px; }
  .order-header { flex-direction: column; align-items: flex-start; gap: 10px; }
  .status { align-self: flex-start; }
}
</style>
</head>

<body>

<nav>
  <div class="nav-line-1">
    <a href="index.html" class="nav-logo">TheKrochet</a>
    <span id="logoutBtn" onclick="logout()">Logout</span>
  </div>
  <div class="nav-line-2 nav-links">
    <a href="index.html">Home</a>
    <a href="products.html">Products</a>
    <a href="profile.html" class="active">My Orders</a>
    <a href="contact.html">Contact</a>
  </div>
</nav>

<div class="container">
  <div class="header">
    <h2 id="userName">Hello, User</h2>
    <p>Your recent order history</p>
  </div>

  <div id="ordersList">
    <div class="empty-state">Loading your orders...</div>
  </div>
</div>

<footer>© 2025 TheKrochet</footer>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* FIREBASE CONFIG */
firebase.initializeApp({
  apiKey:"AIzaSyAbFV0WbIVMpibxnIiVbwtnOqtvJ6ts_sY",
  authDomain:"thekrochet-b3ca2.firebaseapp.com",
  projectId:"thekrochet-b3ca2"
});
const db = firebase.firestore();
const auth = firebase.auth();

if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark");

/* CHECK AUTH */
auth.onAuthStateChanged(user => {
  if(user){
    document.getElementById("userName").innerText = "Hello, " + (user.email.split('@')[0]);
    loadOrders(user.uid);
  } else {
    // If not logged in, redirect to Products page to login
    window.location.href = "products.html";
  }
});

function loadOrders(uid){
  db.collection("orders")
    .where("userId", "==", uid) // Filter orders by THIS user
    .orderBy("createdAt", "desc")
    .onSnapshot(snap => {
      const list = document.getElementById("ordersList");
      list.innerHTML = "";

      if(snap.empty){
        list.innerHTML = "<div class='empty-state'>You haven't placed any orders yet. <br><br> <a href='products.html' style='color:var(--primary);text-decoration:underline;'>Go Shopping</a></div>";
        return;
      }

      snap.forEach(doc => {
        const o = doc.data();
        let itemsHtml = o.items.map(i => 
          `<div class="item-row"><span>${i.name}</span> <span>₹${i.price}</span></div>`
        ).join("");

        // Format Date
        let dateStr = "Recent";
        if(o.createdAt) dateStr = o.createdAt.toDate().toLocaleDateString();

        list.innerHTML += `
          <div class="order-card">
            <div class="order-header">
              <div class="order-id">Order #${doc.id.slice(0,6).toUpperCase()} <br> <small>${dateStr}</small></div>
              <span class="status ${o.status || 'Pending'}">${o.status || 'Pending Check'}</span>
            </div>
            <div class="order-items">
              ${itemsHtml}
            </div>
            <div class="order-total">Total: ₹${o.total}</div>
          </div>
        `;
      });
    });
}

function logout(){
  auth.signOut().then(() => window.location.href = "products.html");
}
</script>

</body>
</html>
