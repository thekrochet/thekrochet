<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Products | TheKrochet</title>

<link rel="stylesheet" href="layout.css">
<link rel="stylesheet" href="responsive.css">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
/* Page Specific Styles */
.img-wrap { position: relative; overflow: hidden; border-radius: 14px; margin-bottom: 12px; }
.img-wrap img { width: 100%; height: 220px; object-fit: cover; cursor: pointer; }
.price { color: var(--primary-dark); font-weight: 600; margin-bottom: 8px; }

/* Cart Floating Button */
.cart-float {
  position: fixed; right: 20px; bottom: 22px;
  background: var(--primary); color: #fff; padding: 14px 20px;
  border-radius: 40px; cursor: pointer; z-index: 999;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* Modal Styling */
#cartModal, #imgModal {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; z-index: 10000; transition: opacity 0.3s;
}
#cartModal.active, #imgModal.active { opacity: 1; pointer-events: auto; }
.cart-box { background: var(--card); width: 90%; max-width: 400px; padding: 25px; border-radius: 22px; }
.cart-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
#popupImg { max-width: 90%; max-height: 80%; border-radius: 10px; }
</style>
</head>

<body>

<nav>
  <div class="nav-top">
      <h2>TheKrochet</h2>
      <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ™</button>
  </div>
  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="products.html" class="active">Products</a>
    <a href="reviews.html">Reviews</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
  </div>
</nav>

<div style="max-width:460px; margin:24px auto 0; padding:0 16px;">
  <input type="text" id="searchInput" placeholder="Search products...">
</div>

<div style="max-width:1320px; margin:0 auto; padding:20px;">
  <div id="products" class="grid"></div>
</div>

<div class="cart-float" onclick="openCart()">ðŸ›’ Cart (<span id="cartCount">0</span>)</div>

<div id="cartModal">
  <div class="cart-box">
    <h3>Your Cart</h3>
    <div id="cartItems" style="max-height: 250px; overflow-y: auto;"></div>
    <div style="font-weight:bold; text-align:right; margin-top:10px;">Total: â‚¹<span id="totalPrice">0</span></div>
    <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn-primary" style="background:transparent; color:var(--text); border:1px solid #ccc;" onclick="closeCart()">Cancel</button>
        <button class="btn-primary" onclick="sendToInstagram()">Send to Instagram</button>
    </div>
  </div>
</div>

<div id="imgModal" onclick="this.classList.remove('active')">
  <img id="popupImg">
</div>

<footer>Â© 2025 TheKrochet</footer>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="main.js"></script>

<script>
const db = firebase.firestore();
const productDiv = document.getElementById("products");
const cartCount = document.getElementById("cartCount");
const cartItems = document.getElementById("cartItems");
const totalPrice = document.getElementById("totalPrice");
const cartModal = document.getElementById("cartModal");
const imgModal = document.getElementById("imgModal");
const popupImg = document.getElementById("popupImg");
const searchInput = document.getElementById("searchInput");

// 1. Initialize Cart with Persistence (LocalStorage)
let cart = JSON.parse(localStorage.getItem('krochetCart')) || [];
let allProducts = [];
updateCartUI();

/* LOAD PRODUCTS FROM FIREBASE */
db.collection("products").orderBy("createdAt","desc").onSnapshot(snap => {
  productDiv.innerHTML = "";
  allProducts = [];
  snap.forEach((doc, i) => {
    const p = doc.data();
    allProducts.push(p);
    renderProduct(p, i);
  });
});

function renderProduct(p, i) {
    productDiv.innerHTML += `
      <div class="card" style="animation: fadeUp 0.6s ease forwards; animation-delay:${i*0.05}s; opacity:0; transform:translateY(20px);">
        <div class="img-wrap">
          <img src="${p.image}" loading="lazy" onclick="openImg('${p.image}')">
        </div>
        <h3>${p.name}</h3>
        <div class="price">â‚¹${p.price}</div>
        <p style="font-size:14px; color:#888; margin-bottom:10px;">${p.description||""}</p>
        <button class="btn-primary" style="width:100%" onclick="addToCart('${p.name}',${p.price})">Add to Cart</button>
      </div>`;
}

/* SEARCH */
searchInput.addEventListener("input", (e) => {
    const val = e.target.value.toLowerCase();
    productDiv.innerHTML = "";
    const filtered = allProducts.filter(p => p.name.toLowerCase().includes(val));
    if(filtered.length === 0) productDiv.innerHTML = "<p style='text-align:center;'>No products found.</p>";
    else filtered.forEach((p, i) => renderProduct(p, i));
});

/* CART FUNCTIONS */
function addToCart(name, price) {
  cart.push({name, price});
  saveCart();
  updateCartUI();
}

function removeItem(i) {
  cart.splice(i, 1);
  saveCart();
  updateCartUI();
}

function saveCart() {
  localStorage.setItem('krochetCart', JSON.stringify(cart));
}

function updateCartUI() {
  cartCount.innerText = cart.length;
  cartItems.innerHTML = "";
  let total = 0;
  
  if(cart.length === 0) {
    cartItems.innerHTML = '<p style="text-align:center; color:#888;">Cart is empty.</p>';
  } else {
    cart.forEach((p, i) => {
        total += p.price;
        cartItems.innerHTML += `
        <div class="cart-item">
            <span>${p.name}</span>
            <div style="display:flex; align-items:center;">
                <span style="font-weight:600; margin-right:10px;">â‚¹${p.price}</span>
                <button style="color:red; border:none; background:none; cursor:pointer;" onclick="removeItem(${i})">âœ•</button>
            </div>
        </div>`;
    });
  }
  totalPrice.innerText = total;
}

function openCart() { cartModal.classList.add("active"); }
function closeCart() { cartModal.classList.remove("active"); }

/* INSTAGRAM CHECKOUT */
async function sendToInstagram() {
    if(cart.length === 0) return;
    let msg = "Hello, I want to order:\n";
    let total = 0;
    cart.forEach(p => { msg += `- ${p.name}: â‚¹${p.price}\n`; total += p.price; });
    msg += `\nTotal: â‚¹${total}`;
    
    // Copy to clipboard
    try { await navigator.clipboard.writeText(msg); } catch (err) {}
    
    // Open Instagram
    window.location.href = "https://www.instagram.com/direct/inbox/";
}

function openImg(src) { popupImg.src = src; imgModal.classList.add("active"); }
</script>
</body>
</html>

