<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Products | TheKrochet</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">

<link rel="stylesheet" href="brand.css">
<link rel="stylesheet" href="responsive.css">

<style>
/* =========================================
   PAGE SPECIFIC STYLES
   ========================================= */
:root{
  --bg:#faf7f2; --text:#2f2f2f; --card:#ffffff; --nav:#ffffff;
  --shadow:rgba(0,0,0,0.08); 
  --primary:#d4a373; --primary-dark:#b8895b; 
  --ease-spring: cubic-bezier(0.4, 0.0, 0.2, 1);
}
body.dark{
  --bg:#121212; --text:#f1f1f1; --card:#1e1e1e; --nav:#1a1a1a; --shadow:rgba(0,0,0,0.6);
  --gray:#333;
}
*{margin:0;padding:0;box-sizing:border-box}
html { scroll-behavior: smooth; }
body{
  font-family:'Poppins',sans-serif; background:var(--bg); color:var(--text);
  min-height:100vh; display:flex; flex-direction:column; overflow-x: hidden;
  transition: background 0.5s var(--ease-spring);
}

/* NAVBAR (Synced) */
nav {
  position: sticky; top: 0; z-index: 100;
  background: var(--nav); backdrop-filter: blur(10px);
  padding: 10px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
  display: flex; flex-direction: column; gap: 8px;
}
.nav-line-1 { position: relative; width: 100%; display: flex; justify-content: center; align-items: center; padding: 0 15px; }
.nav-logo { font-family: 'Playfair Display', serif; font-size: 1.8rem; color: var(--text); text-decoration: none; font-weight: 700; }

/* Profile Button (Triggers profile.js) */
#userBtn {
  position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
  width: 38px; height: 38px; border-radius: 50%;
  border: 1px solid var(--primary); color: var(--primary);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: 0.3s;
}
#userBtn:hover { background: var(--primary); color: #fff; }

.nav-line-2 { display: flex; justify-content: center; gap: 20px; }
.nav-links a { text-decoration: none; color: var(--text); font-weight: 500; font-size: 0.9rem; opacity: 0.7; transition: 0.3s; position: relative; padding-bottom: 2px; }
.nav-links a.active, .nav-links a:hover { opacity: 1; color: var(--primary); }
.nav-links a::after { content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0; background: var(--primary); transition: 0.3s; }
.nav-links a:hover::after, .nav-links a.active::after { width: 100%; }

/* PRODUCTS & CARDS */
.search-box{ max-width:460px; margin:20px auto 0; padding:0 16px; }
.search-box input{ width:100%; padding:14px 24px; border-radius:50px; border:2px solid transparent; background:var(--card); color:var(--text); box-shadow: 0 4px 15px var(--shadow); outline: none; transition: 0.3s; }
.search-box input:focus{ border-color: var(--primary); }

.products-section{ max-width:1200px; margin:auto; padding:20px 20px 80px; }
#products{ display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:25px; }

.card{ background:var(--card); padding:15px; border-radius:24px; box-shadow:0 10px 20px var(--shadow); display:flex; flex-direction:column; overflow: hidden; animation: fadeUp 0.6s ease forwards; }
@keyframes fadeUp { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }

.img-window { width: 100%; height: 230px; border-radius: 20px; overflow: hidden; cursor: pointer; position: relative; margin-bottom: 15px; }
.img-slider { display: flex; height: 100%; width: 100%; transition: transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1); }
.img-slider img { min-width: 100%; width: 100%; height: 100%; object-fit: cover; }

.card h3{ margin-top:5px; font-size:1.1rem; font-weight: 600; color: var(--text); }
.price{ color:var(--primary-dark); font-weight:700; font-size: 1.1rem; margin-bottom: 8px; }
.card p{ font-size: 0.85rem; opacity: 0.75; margin-bottom: 15px; line-height: 1.4; }
.card button{ margin-top:auto; padding:12px; border:none; border-radius:18px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color:#fff; font-weight:600; cursor:pointer; width: 100%; box-shadow: 0 4px 15px rgba(212, 163, 115, 0.4); }

/* CART & MODALS SPECIFIC TO PRODUCTS */
.cart-float{ position:fixed; right:20px; bottom:30px; background:var(--primary); color:#fff; padding:16px 26px; border-radius:50px; cursor:pointer; z-index:999; font-weight: 600; box-shadow:0 10px 30px rgba(0,0,0,.3); animation: floaty 4s ease-in-out infinite; }
@keyframes floaty { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

/* Shared Modal Styles are in brand.css, only overrides here if needed */
.pay-apps-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
.pay-app-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px; border-radius: 12px; border: 1px solid #eee; cursor: pointer; background: #f9f9f9; transition: 0.2s; }
.pay-app-btn:hover { border-color: var(--primary); background: #fff; transform: translateY(-2px); }
.pay-app-icon { font-size: 1.4rem; margin-bottom: 5px; }
.confirm-btn { width:100%; padding:14px; border:none; border-radius:12px; background:#27ae60; color:#fff; font-weight:bold; cursor:pointer; margin-top:15px; font-size:1rem; }

#imgModal .modal-box { max-width: 600px; width: 95%; background: transparent; box-shadow: none; padding: 0; overflow: hidden; }
.popup-slider { display: flex; width: 100%; transition: transform 0.5s ease; }
.popup-slider img { min-width: 100%; width: 100%; border-radius: 15px; object-fit: contain; max-height: 80vh; }
</style>
</head>

<body>

<nav data-aos="fade-down">
  <div class="nav-line-1">
    <a href="index.html" class="nav-logo">TheKrochet</a>
    <div id="userBtn" onclick="handleProfileClick()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
    </div>
  </div>
  <div class="nav-line-2 nav-links">
    <a href="index.html">Home</a>
    <a href="products.html" class="active">Products</a>
    <a href="reviews.html">Reviews</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
  </div>
</nav>

<div class="search-box"><input id="searchInput" placeholder="Search products..."></div>
<div class="products-section"><div id="products"></div></div>
<div id="cartFloat" class="cart-float" onclick="openCart()">ðŸ›’ Cart (<span id="cartCount">0</span>)</div>

<div id="cartModal" class="modal">
  <div class="modal-box">
    <h3>Your Cart</h3>
    <div id="cartItems"></div>
    <div style="text-align:right;font-weight:bold;margin-top:15px;color:var(--primary-dark)">Total â‚¹<span id="totalPrice">0</span></div>
    <div style="display:flex;gap:10px;margin-top:20px;">
      <button style="flex:1;padding:12px;border:none;border-radius:12px;background:#eee;color:#555;" onclick="closeModal('cartModal')">Close</button>
      <button style="flex:1;padding:12px;border:none;border-radius:12px;background:var(--primary);color:#fff;font-weight:600;" onclick="checkLoginForOrder()">Continue</button>
    </div>
  </div>
</div>

<div id="orderModal" class="modal">
  <div class="modal-box">
    <h3>Shipping Details</h3>
    <input id="custName" placeholder="Full Name">
    <input id="custInsta" placeholder="Instagram Username (@user)">
    <textarea id="custAddress" rows="3" placeholder="Full Delivery Address (Street, City, Pincode)"></textarea>
    <div style="display:flex;gap:10px;margin-top:20px;">
      <button style="flex:1;padding:12px;border-radius:12px;border:none;background:#eee;color:#555;" onclick="closeModal('orderModal')">Back</button>
      <button style="flex:1;padding:12px;border-radius:12px;border:none;background:var(--primary);color:#fff;font-weight:600;" onclick="openPaymentModal()">Proceed to Pay</button>
    </div>
  </div>
</div>

<div id="paymentAppModal" class="modal">
  <div class="modal-box">
    <h3>Select Payment App</h3>
    <p style="text-align:center;font-size:0.9rem;opacity:0.7;">Pay â‚¹<span id="payAmountDisplay">0</span></p>
    <div class="pay-apps-grid">
      <div class="pay-app-btn" onclick="launchUPI('gpay')"><span class="pay-app-icon" style="color:#4285F4">ðŸ‡¬</span><span class="pay-app-name">Google Pay</span></div>
      <div class="pay-app-btn" onclick="launchUPI('paytm')"><span class="pay-app-icon" style="color:#00BAF2">ðŸ‡µ</span><span class="pay-app-name">Paytm</span></div>
      <div class="pay-app-btn" onclick="launchUPI('phonepe')"><span class="pay-app-icon" style="color:#5F259F">ðŸŸ£</span><span class="pay-app-name">PhonePe</span></div>
      <div class="pay-app-btn" onclick="launchUPI('upi')"><span class="pay-app-icon" style="color:#E05C43">âš¡</span><span class="pay-app-name">Other UPI</span></div>
    </div>
    <button style="width:100%;padding:10px;border:none;background:transparent;color:#888;margin-top:15px;cursor:pointer;" onclick="closeModal('paymentAppModal')">Cancel</button>
  </div>
</div>

<div id="confirmCheckModal" class="modal">
  <div class="modal-box" style="text-align:center;">
    <h3>Payment Pending</h3>
    <p style="opacity:0.8;margin-bottom:15px;">We opened the payment app. Please complete the transaction.</p>
    <button class="confirm-btn" onclick="confirmAndFinishOrder()">I Have Paid Successfully âœ…</button>
    <button style="width:100%;padding:10px;border:none;background:transparent;color:#888;margin-top:10px;cursor:pointer;" onclick="closeModal('confirmCheckModal')">Cancel / Retry</button>
  </div>
</div>

<div id="imgModal" class="modal" onclick="closeImg(event)"><div class="modal-box" id="imgBox"></div></div>

<footer>Â© 2025 TheKrochet</footer>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>

<script>
AOS.init({duration:900,once:true});
if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark");

const myUPI = "6351294436@ptaxis"; 
const myName = "TheKrochet";

// FIREBASE INIT (Required before profile.js)
firebase.initializeApp({
  apiKey:"AIzaSyAbFV0WbIVMpibxnIiVbwtnOqtvJ6ts_sY",
  authDomain:"thekrochet-b3ca2.firebaseapp.com",
  projectId:"thekrochet-b3ca2"
});
const db = firebase.firestore();
// Auth is handled in profile.js globally, but we need currentUser for cart logic
let currentUser = null;
firebase.auth().onAuthStateChanged(user => { currentUser = user; });

let cart = JSON.parse(localStorage.getItem("krochetCart")) || [];
let currentTotal = 0;
let popupInterval = null;

/* PRODUCTS LOGIC */
const productsDiv = document.getElementById("products");
db.collection("products").orderBy("createdAt","desc").onSnapshot(snap=>{
  productsDiv.innerHTML="";
  snap.forEach((doc, idx)=>{
    const p=doc.data();
    let imgs = p.images || (p.image && p.image.includes(",") ? p.image.split(",").map(u=>u.trim()) : [p.image]);
    const sid="s"+Math.random().toString(36).slice(2);
    const imgHtml = imgs.map(url => `<img src="${url}">`).join('');
    
    productsDiv.innerHTML+=`<div class="card" style="animation-delay:${idx*50}ms"><div class="img-window" onclick='openImg(${JSON.stringify(imgs)})'><div id="${sid}" class="img-slider">${imgHtml}</div></div><h3>${p.name}</h3><div class="price">â‚¹${p.price}</div><p>${p.description||""}</p><button onclick="addToCart('${p.name}',${p.price})">Add to Cart</button></div>`;
    
    if(imgs.length > 1){ let i=0; setInterval(()=>{ i=(i+1)%imgs.length; const s=document.getElementById(sid); if(s) s.style.transform=`translateX(-${i * 100}%)`; }, 2500); }
  });
});
document.getElementById("searchInput").addEventListener("input",(e)=>{ const v=e.target.value.toLowerCase(); document.querySelectorAll(".card").forEach(c=>{ c.style.display = c.innerText.toLowerCase().includes(v) ? "flex" : "none"; }); });

function addToCart(name,price){ cart.push({name,price}); localStorage.setItem("krochetCart",JSON.stringify(cart)); document.getElementById("cartFloat").classList.add("cart-bump"); setTimeout(()=>document.getElementById("cartFloat").classList.remove("cart-bump"), 300); updateCartUI(); }
function updateCartUI(){ const items=document.getElementById("cartItems"); items.innerHTML=""; currentTotal=0; cart.forEach((p,i)=>{ currentTotal+=p.price; items.innerHTML+=`<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee"><span>${p.name}</span><span>â‚¹${p.price} <b style="color:red;margin-left:10px;cursor:pointer" onclick="removeItem(${i})">âœ–</b></span></div>`; }); document.getElementById("cartCount").innerText=cart.length; document.getElementById("totalPrice").innerText=currentTotal; }
function removeItem(i){ cart.splice(i,1); localStorage.setItem("krochetCart",JSON.stringify(cart)); updateCartUI(); }

/* MODALS */
// openModal/closeModal are now in profile.js, but we override locally if needed or rely on global.
// Since profile.js defines them globally, we can use them directly.

function openCart(){ openModal('cartModal'); updateCartUI(); }

function openImg(imgs){
  const imgBox = document.getElementById("imgBox");
  const slidesHtml = imgs.map(src => `<img src="${src}">`).join('');
  imgBox.innerHTML = `<div class="popup-slider" id="popupSlider">${slidesHtml}</div>`;
  openModal('imgModal');
  if(imgs.length > 1){
    let i = 0;
    if(popupInterval) clearInterval(popupInterval);
    popupInterval = setInterval(() => {
      i = (i + 1) % imgs.length;
      const slider = document.getElementById("popupSlider");
      if(slider) slider.style.transform = `translateX(-${i * 100}%)`;
    }, 1700);
  }
}
function closeImg(e){ 
  if(e.target.id==="imgModal") {
    closeModal('imgModal');
    if(popupInterval) clearInterval(popupInterval);
  }
}

/* ORDER LOGIC */
function checkLoginForOrder(){ 
  closeModal('cartModal'); 
  // We use the global 'currentUser' updated by auth listener
  if(currentUser) {
      // Auto-fill address if available in Sidebar
      const savedAddr = document.getElementById("sidebarAddress")?.innerText;
      if(savedAddr && savedAddr !== "No address saved." && savedAddr !== "Login to see address") {
          document.getElementById("custAddress").value = savedAddr;
      }
      openModal('orderModal');
  } else {
      openModal('authModal'); 
  }
}

function openPaymentModal(){
  const name=document.getElementById("custName").value.trim();
  const insta=document.getElementById("custInsta").value.trim();
  const addr=document.getElementById("custAddress").value.trim();
  if(!name||!insta||!addr) return alert("Please fill Name, Instagram, and Address.");
  document.getElementById("payAmountDisplay").innerText = currentTotal;
  closeModal('orderModal');
  openModal('paymentAppModal');
}

function launchUPI(appType){
  let link = `upi://pay?pa=${myUPI}&pn=${myName}&am=${currentTotal}&cu=INR`;
  if(appType==='paytm') link = `paytmmp://pay?pa=${myUPI}&pn=${myName}&am=${currentTotal}&cu=INR`;
  if(appType==='phonepe') link = `phonepe://pay?pa=${myUPI}&pn=${myName}&am=${currentTotal}&cu=INR`;
  window.location.href = link;
  closeModal('paymentAppModal');
  setTimeout(()=>{ openModal('confirmCheckModal'); }, 1000);
}

function confirmAndFinishOrder(){
  const name=document.getElementById("custName").value.trim();
  const insta=document.getElementById("custInsta").value.trim();
  const addr=document.getElementById("custAddress").value.trim();
  db.collection("orders").add({
    customerName: name, instagram: insta, address: addr,
    items: cart, total: currentTotal, status: "Paid via UPI",
    userId: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    alert("Order Confirmed! Thank you.");
    cart=[]; localStorage.removeItem("krochetCart");
    location.reload(); 
  });
}
updateCartUI();
</script>

<script src="profile.js"></script>

</body>
</html>

